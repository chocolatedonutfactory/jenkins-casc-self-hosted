services:
  # Jenkins (internal only)
  jenkins:
    build: ./jenkins-image
    container_name: lab_jenkins
    networks:
      - jenkins_net
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - JENKINS_OPTS=--httpPort=${JENKINS_HTTP_PORT}
      - CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs/jenkins.yaml
      - OIC_CLIENT_ID=jenkins
      - OIC_CLIENT_SECRET=${OIC_CLIENT_SECRET}
      - OIC_WELL_KNOWN_URL=https://jenkins.lab.local:8444/realms/jenkins-lab/.well-known/openid-configuration

  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_IMAGE_VERSION}
    container_name: lab_keycloak
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_PROXY=edge
      - KC_HOSTNAME_URL=https://jenkins.lab.local:8444/
    networks:
      - jenkins_net
    expose:
      - "8080"

  # Nginx TLS reverse proxy
  nginx:
    image: nginx:${NGINX_IMAGE_VERSION}
    container_name: lab_nginx
    networks:
      - jenkins_net
    depends_on:
      - keycloak

networks:
  jenkins_net:
    driver: bridge
